# SHOGUN Trade System 仕様書・引継書

## 1. システム概要

### 1.1 基本情報
- システム名: SHOGUN Trade System
- 開発言語: TypeScript/Next.js
- データベース: PostgreSQL (Supabase)
- 認証: Supabase Auth

### 1.2 主要機能
1. NFT購入・管理システム
2. ユーザー紹介システム
3. 報酬計算システム
4. 管理者機能

## 2. システム構成

### 2.1 フロントエンド
- Next.js (App Router)
- TailwindCSS
- Supabase Client

### 2.2 バックエンド
- Supabase
- Edge Functions
- PostgreSQL

### 2.3 認証システム
- Supabase Auth
- JWT認証
- Role Based Access Control (RBAC)

## 3. データベース設計

### 3.1 主要テーブル
1. users
   - ユーザー基本情報
   - auth.usersと連携

2. nft_settings
   - NFT商品マスタ
   - 価格、日利率等の設定

3. nft_purchase_requests
   - NFT購入リクエスト管理
   - ステータス: pending/approved/rejected

4. daily_profits
   - 日次利益記録
   - NFTごとの収益計算基準

### 3.2 重要な制約
- ユーザーIDはUUID
- 外部キー制約の厳密な管理
- 論理削除の実装

## 4. 重要な仕様

### 4.1 NFT運用ルール
- 購入後30日間は待機期間
- 運用開始は待機期間後の最初の月曜日から
- 日利計算は平日（月-金）のみ
- NFTタイプ別の日利上限
  - 通常NFT: 0.5-2.0%
  - 特例NFT: 個別設定

### 4.2 報酬計算
- 日次報酬の自動計算
- 紹介報酬の計算
- レベルに応じた報酬率の適用

### 4.3 ユーザーレベル
- レベル判定条件
  - 最大ライン投資額
  - その他ライン投資額
  - 個人投資額

## 5. 運用・保守

### 5.1 定期タスク
- 日次報酬計算 (毎日0時)
- レベル再計算 (毎日1時)
- バックアップ (毎日3時)

### 5.2 監視項目
- NFT購入リクエストの承認待ち状況
- 報酬計算の実行状況
- ユーザー登録状況

### 5.3 異常時の対応
1. データ不整合の検出
   - check_database_integrity.sqlの実行
   - 必要に応じてfix_*.sqlの実行

2. 報酬計算エラー
   - ログの確認
   - 手動での再計算実行

## 6. セキュリティ

### 6.1 認証・認可
- Supabase RLSの適切な設定
- 管理者権限の厳密な管理
- APIエンドポイントの保護

### 6.2 データ保護
- 環境変数による機密情報の管理
- バックアップの暗号化
- ログのサニタイズ

## 7. 既知の問題と対応

### 7.1 重要な注意点
1. ユーザー登録日の扱い
   - 登録日は実際の日付を保持すること
   - 2024年以前の日付も許容

2. NFT購入承認の注意点
   - 同一NFTの重複承認を防ぐ
   - 承認順序の厳密な管理

3. 報酬計算の制限
   - 過去データの再計算には注意
   - 計算順序の依存関係を考慮

### 7.2 未解決の課題
1. パフォーマンス最適化
   - 大量データ時のクエリ最適化
   - キャッシュ戦略の改善

2. スケーラビリティ
   - 同時接続数の制限
   - バッチ処理の分散化

## 8. 今後の改善点

### 8.1 短期的な改善
1. エラーハンドリングの強化
2. ログ収集の改善
3. テストカバレッジの向上

### 8.2 中長期的な改善
1. マイクロサービス化の検討
2. リアルタイム機能の強化
3. 分析基盤の整備

## 9. 連絡先・参考情報

### 9.1 重要な連絡先
- システム管理者
- データベース管理者
- セキュリティ担当者

### 9.2 参考ドキュメント
- API仕様書
- データベース設計書
- 運用手順書

## 10. 変更履歴

### 10.1 主要な変更
- 2024-03-XX: 初版作成
- 2024-03-XX: NFT管理機能の追加
- 2024-03-XX: 報酬計算ロジックの改修

### 10.2 今後の予定
- セキュリティ強化
- パフォーマンス改善
- UI/UX改善 

# 環境変数の設定
$env:PGPASSWORD = "your_actual_password"

# バックアップの実行
$date = Get-Date -Format "yyyyMMdd"
pg_dump -U postgres -h localhost -d your_actual_database_name > "backup_$date.sql"

# レベル要件仕様

## 基本要件
- すべてのレベルにおいて、SHOGUN NFT1000の保有が必須条件
- レベルは上位から順に判定
- 条件を満たさない場合は下位レベルを確認
- どのレベルの条件も満たさない場合は 'none'

## レベル詳細

### 将軍 (shogun)
- 最大系列: 600,000以上
- 他系列合計: 500,000以上
- 分配率: 2%

### 大名 (daimyo)
- 最大系列: 300,000以上
- 他系列合計: 150,000以上
- 分配率: 3%

### 大老 (tairo)
- 最大系列: 100,000以上
- 他系列合計: 50,000以上
- 分配率: 4%

### 老中 (roju)
- 最大系列: 50,000以上
- 他系列合計: 25,000以上
- 分配率: 5%

### 奉行 (bugyo)
- 最大系列: 10,000以上
- 他系列合計: 5,000以上
- 分配率: 6%

### 代官 (daikan)
- 最大系列: 5,000以上
- 他系列合計: 2,500以上
- 分配率: 10%

### 武将 (busho)
- 最大系列: 3,000以上
- 他系列合計: 1,500以上
- 分配率: 25%

### 足軽 (ashigaru)
- SHOGUN NFT1000の保有のみ
- 分配率: 45% 